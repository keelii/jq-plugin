!function($){"use strict";function Jcal(that,options,callback){this.opts=$.extend({id:"J-calendar",start:"1995-5-1",end:"2043-5-1",outputFormat:"{Y}-{M}-{D}",weekName:["\u65e5","\u4e00","\u4e8c","\u4e09","\u56db","\u4e94","\u516d"],today:!0,hoverClass:"J-cal-hover",currentDay:"J-cal-active",close:!1,curr:new Date},options),this.$el=$(that),this.callback=callback||function(){},this.init()}Jcal.prototype={init:function(){this.renderTPL(),this.cal=$("#"+this.opts.id),this.sYear=this.cal.find(".J-cal-select-year select"),this.sMonth=this.cal.find(".J-cal-select-month select"),this.switcher=this.cal.find(".J-cal-switch"),this.close=this.cal.find(".J-cal-close"),this.current=this.formatDate(this.opts.curr),this.highLight=this.formatDate(this.opts.curr),this.initStyle(),this.setSelect(this.current),this.renderWeek(this.current),this.renderDate(),this.bindEvent(),this.opts.close&&this.close.show()},renderTPL:function(){var TPL='            <div id="{ID}" class="J-cal" style="display:none">                <div class="J-cal-change">                    <span data-sign="py" class="J-cal-switch prev-year"> \xab </span>                    <span data-sign="pm" class="J-cal-switch prev-month"> \u2039 </span>                    <span class="J-cal-select-year">                        <select name=""></select>                    </span>                    <span class="J-cal-select-month">                        <select name=""></select>                    </span>                    <span data-sign="nm" class="J-cal-switch next-month"> \u203a </span>                    <span data-sign="ny" class="J-cal-switch next-year"> \xbb </span>                </div>                <div class="J-cal-weeks"></div>                <div class="J-cal-body"></div>                <div class="J-footer"><span class="J-cal-today">\u4eca\u5929</span><span class="J-cal-close" style="display:none">&times;</span></div>            </div>';$("#"+this.opts.id).length<1&&(TPL=TPL.replace("{ID}",this.opts.id),$("body").eq(0).append(TPL))},initStyle:function(){var el=this.$el,h=el.outerHeight(),oLeft=el.offset().left,oTop=el.offset().top;this.cal.css({position:"absolute",top:oTop+h,left:oLeft})},formatDate:function(fullDate){var dateArr,now,dateRe=/\d{4}-\d{1,2}-\d{1,2}/;if("string"==typeof fullDate){if(!dateRe.test(fullDate))throw new Error("Illegal date string :`"+currTimeString+"`.");dateArr=fullDate.split("-"),now=new Date(dateArr[0],parseInt(dateArr[1])-1,dateArr[2])}else{if(isNaN(fullDate.getDate()))throw new Error("Illegal date string :"+fullDate);now=fullDate}var currYear=now.getFullYear(),currMonth=now.getMonth()+1,currDate=now.getDate(),currDay=now.getDay(),firstDay=new Date(currYear,currMonth-1,1).getDay();return{year:currYear,month:currMonth,date:currDate,day:currDay,firstDay:firstDay}},bindEvent:function(){var _this=this;this.sYear.unbind().bind("change",function(){_this.renderDate()}),this.sMonth.unbind().bind("change",function(){_this.renderDate()}),this.switcher.unbind().bind("click",function(){var sign=$(this).attr("data-sign");_this.goTo(sign)}),this.close.unbind().bind("click",function(){_this.hide()}),this.$el.unbind().bind("click",function(){return _this.show(),!1}),this.cal.unbind().bind("click",function(e){var el=$(e.target),date=parseInt(el.attr("data-date")),now=_this.formatDate(new Date),isPrevDate=el.is(".J-prev-month-date"),isNextDate=el.is(".J-next-month-date");return el.attr("data-date")&&(isPrevDate&&(_this.prevMonth(),_this.renderDate()),isNextDate&&(_this.nextMonth(),_this.renderDate()),_this.chooseDate(date),_this.markSelected()),_this.opts.today&&el.hasClass("J-cal-today")&&(_this.sYear.val(now.year),_this.sMonth.val(now.month),_this.current.year=now.year,_this.current.month=now.month,_this.chooseDate(now.date),_this.hide()),!1}),$(document).unbind("click.Jcal").bind("click.Jcal",function(){_this.hide()})},show:function(){this.cal.show(),this.markSelected()},hide:function(){this.cal.hide()},markSelected:function(){var year=this.current.year,month=this.current.month,hYear=this.highLight.year,hMonth=this.highLight.month,hDate=this.highLight.date;this.cal.find("[data-date]").removeClass(this.opts.currentDay),year===hYear&&month===hMonth&&this.cal.find("[data-curr-month]").filter('[data-date="'+hDate+'"]').addClass(this.opts.currentDay)},chooseDate:function(date){this.updateCurrent(),this.current.date=date,this.$el.val(this.opts.outputFormat.replace("{Y}",this.current.year).replace("{M}",this.current.month).replace("{D}",this.current.date)),this.highLight=$.extend(!0,{},this.current),this.callback&&this.callback.apply(this),this.hide()},prevYear:function(){this.current.year-1>=this.yearHead?this.sYear.val(--this.current.year):this.logWarning()},nextYear:function(){this.current.year+1<=this.yearTail?this.sYear.val(++this.current.year):this.logWarning()},prevMonth:function(){this.current.month-1>=1?this.sMonth.val(--this.current.month):(this.sMonth.val(12),this.prevYear())},nextMonth:function(){this.current.month+1<=12?this.sMonth.val(++this.current.month):(this.sMonth.val(1),this.nextYear())},logWarning:function(){"undefined"!=typeof console&&console.warn("Date out of range.")},goTo:function(dir){switch(dir){case"py":this.prevYear();break;case"ny":this.nextYear();break;case"pm":this.prevMonth();break;case"nm":this.nextMonth()}this.renderDate()},updateCurrent:function(){this.current.year=parseInt(this.sYear.val()),this.current.month=parseInt(this.sMonth.val()),this.current.day=1,this.current.firstDay=new Date(this.current.year,this.current.month-1,1).getDay()},setSelect:function(fullDate){var selectYear=this.cal.find(".J-cal-select-year select"),selectMonth=this.cal.find(".J-cal-select-month select"),start=this.formatDate(this.opts.start),end=this.formatDate(this.opts.end);this.yearHead=start.year,this.monthHead=start.month,this.yearTail=end.year,this.monthTail=end.month;for(var yearOptions="",i=start.year;i<=end.year;i++)yearOptions+='<option value="'+i+'">'+i+"</option>";for(var monthOptions="",k=1;13>k;k++)monthOptions+='<option value="'+k+'">'+k+"</option>";selectYear.html(yearOptions),selectMonth.html(monthOptions),selectYear.val(fullDate.year),selectMonth.val(fullDate.month),this.$el.val(this.current.year+"-"+this.current.month+"-"+this.current.date)},isLeapYear:function(year){return year%4==0&&year%100!=0||year%400==0},getFullDateCount:function(fullDate){var dateRe=new RegExp("-"+fullDate.month+"-"),month31="-1-3-5-7-8-10-12-",febDateCount=this.isLeapYear(fullDate.year)?29:28;return dateRe.test(month31)?31:2==fullDate.month?febDateCount:30},renderWeek:function(){for(var weekName=this.opts.weekName,len=weekName.length,weekEl=this.cal.find(".J-cal-weeks"),resHTML="",i=0;len>i;i++)resHTML+='<span class="J-cal-weekname'+i+'">'+weekName[i]+"</span>";weekEl.html(resHTML)},renderDate:function(d){var dateCount,date,k=1,dateHTML="";date="undefined"!=typeof d?this.formatDate(d):this.current,this.updateCurrent(),dateCount=this.getFullDateCount(date),dateHTML+="<ul>";for(var i=0;6>i;i++){dateHTML+="<li>";for(var j=0;7>j;j++)k>dateCount?dateHTML+='<span class="J-cal-week'+j+' J-cal-date J-next-month-date">&nbsp;</span>':0==i?j>date.firstDay-1?(dateHTML+='<span class="J-cal-week'+j+" J-cal-date"+k+'" data-curr-month="1" data-week="'+j+'" data-date="'+k+'">'+k+"</span>",k++):dateHTML+='<span class="J-cal-week'+j+' J-cal-date J-prev-month-date" data-date="">&nbsp;</span>':(dateHTML+='<span class="J-cal-week'+j+" J-cal-date"+k+'" data-curr-month="1" data-week="'+j+'" data-date="'+k+'">'+k+"</span>",k++);if(dateHTML+="</li>",k>dateCount)break}dateHTML+="</ul>",this.cal.find(".J-cal-body").html(dateHTML),this.fillPrevMonthDate(date,dateCount),this.fillNextMonthDate(date,dateCount),this.markSelected()},fillPrevMonthDate:function(d){var days=d.firstDay,date=+new Date(d.year,d.month-1,1);if(days>0)for(var i=days-1;i>=0;i--){date-=864e5;var currDate=new Date(date).getDate();this.cal.find(".J-cal-body li:first").find(".J-cal-week"+i).attr("data-date",currDate).text(currDate)}},fillNextMonthDate:function(d,dCount){var lastWeekDays=(d.firstDay+dCount)%7,days=lastWeekDays>0?7-lastWeekDays:0;if(days>0)for(var i=0;days>i;i++)this.cal.find(".J-cal-body li:last").find(".J-cal-week"+(i+lastWeekDays)).attr("data-date",i+1).text(i+1)}},$.fn.Jcal=function(options,callback){return this.each(function(){var plugin=new Jcal(this,options,callback);$(this).data("Jcal",plugin)})}}(jQuery);